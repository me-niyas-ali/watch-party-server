<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Watch Party Streaming</title>
<style>
body { background:#111; color:#eee; font-family:system-ui; padding:20px }
video { width:100%; max-width:900px; background:black }
.box { margin-top:16px }
input, button { padding:8px; margin-top:8px }
code { background:#222; padding:4px 6px }
</style>
</head>
<body>
<h1>ðŸŽ¬ Watch Party Streaming</h1>

<div class="box">
  <strong>Select Role:</strong><br>
  <button onclick="selectRole('host')">Host</button>
  <button onclick="selectRole('guest')">Join</button>
</div>

<div id="hostOptions" class="box" style="display:none;">
  <strong>Select Video to Stream:</strong><br>
  <input type="file" id="fileInput" accept="video/*"><br>
  <strong>Room Code:</strong> <code id="roomCode">(generatingâ€¦)</code><br>
  <strong>Total Connected Devices:</strong> <span id="count">1</span>
</div>

<div id="guestOptions" class="box" style="display:none;">
  <strong>Enter Room Code:</strong><br>
  <input id="joinCode" placeholder="6-digit room code">
  <button onclick="joinRoom()">Join</button>
  <br><strong>Total Connected Devices:</strong> <span id="countGuest">1</span>
</div>

<video id="video" controls autoplay muted></video>

<script>
let role, ws, pc, roomCode;
const video = document.getElementById('video');
const roomCodeEl = document.getElementById('roomCode');
const countEl = document.getElementById('count');
const countGuestEl = document.getElementById('countGuest');

function selectRole(selectedRole){
  role = selectedRole;
  document.getElementById('hostOptions').style.display = role==='host'?'block':'none';
  document.getElementById('guestOptions').style.display = role==='guest'?'block':'none';

  ws = new WebSocket('ws://localhost:3000');

  ws.onmessage = msg=>{
    const data = JSON.parse(msg.data);
    if(data.type==='offer' && role==='guest') handleOffer(data);
    if(data.type==='answer' && role==='host') handleAnswer(data);
    if(data.type==='candidate') handleCandidate(data);
    if(data.type==='count'){
      if(role==='host') countEl.textContent = data.count;
      else countGuestEl.textContent = data.count;
    }
  }

  if(role==='host'){
    roomCode = Math.floor(100000 + Math.random()*900000).toString();
    roomCodeEl.textContent = roomCode;
  }
}

// -------------------- Host --------------------
document.getElementById('fileInput').addEventListener('change', async e=>{
  const file = e.target.files[0];
  if(!file) return;
  video.src = URL.createObjectURL(file);
  await video.play();
  
  // Capture stream
  const stream = video.captureStream();

  pc = new RTCPeerConnection();
  stream.getTracks().forEach(track=>pc.addTrack(track, stream));

  pc.onicecandidate = e=>{
    if(e.candidate) ws.send(JSON.stringify({type:'candidate', candidate:e.candidate}));
  }

  // Wait for guests to join: host waits for signaling offers from guests
});

function handleAnswer(data){
  pc.setRemoteDescription(new RTCSessionDescription(data.answer));
}

function handleCandidate(data){
  if(pc) pc.addIceCandidate(new RTCIceCandidate(data.candidate));
}

// -------------------- Guest --------------------
async function joinRoom(){
  roomCode = document.getElementById('joinCode').value.trim();
  if(!roomCode) return;

  pc = new RTCPeerConnection();
  pc.ontrack = e=>{
    video.srcObject = e.streams[0];
  }
  pc.onicecandidate = e=>{
    if(e.candidate) ws.send(JSON.stringify({type:'candidate', candidate:e.candidate}));
  }

  // Notify server to join room
  ws.onopen = ()=>ws.send(JSON.stringify({type:'join', room:roomCode}));

  // Guest creates offer
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  ws.send(JSON.stringify({type:'offer', offer, room:roomCode}));
}

async function handleOffer(data){
  await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  ws.send(JSON.stringify({type:'answer', answer, room:roomCode}));
}

</script>
</body>
</html>
