<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Video Watch Party</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
    #room-selection, #controls { margin-bottom: 20px; }
    #video-container { margin-top: 20px; }
    video { width: 80%; max-width: 700px; }
    button { margin-right: 10px; padding: 10px; }
  </style>
</head>
<body>
  <h1>Watch Party</h1>

  <div id="room-selection">
    <button id="hostBtn">Host</button>
    <button id="joinBtn">Join</button>
    <input type="text" id="roomInput" placeholder="Enter room code" style="display:none"/>
    <button id="joinRoomBtn" style="display:none">Join Room</button>
  </div>

  <div id="status">Not connected</div>
  <div>Total Connected: <span id="total">0</span></div>

  <div id="upload-container" style="display:none">
    <input type="file" id="videoFile"/>
  </div>

  <div id="video-container">
    <video id="video" controls></video>
  </div>

  <div id="controls" style="display:none">
    <button id="playBtn">Play</button>
    <button id="pauseBtn">Pause</button>
  </div>

  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <script>
    const socket = io(); // Connects to server
    let room = '';
    let isHost = false;
    let video = document.getElementById('video');

    // Room selection
    document.getElementById('hostBtn').onclick = () => {
      isHost = true;
      room = Math.floor(1000 + Math.random() * 9000).toString();
      alert("Your room code: " + room);
      socket.emit('joinRoom', room);
      afterJoin();
    }

    document.getElementById('joinBtn').onclick = () => {
      document.getElementById('roomInput').style.display = 'inline';
      document.getElementById('joinRoomBtn').style.display = 'inline';
    }

    document.getElementById('joinRoomBtn').onclick = () => {
      room = document.getElementById('roomInput').value;
      if(room.length !== 4){ alert('Enter 4-digit room code'); return; }
      socket.emit('joinRoom', room);
      afterJoin();
    }

    function afterJoin(){
      document.getElementById('status').innerText = 'Connected to server';
      document.getElementById('upload-container').style.display = 'block';
      document.getElementById('controls').style.display = 'block';
    }

    // Update connected count
    socket.on('updateCount', count => {
      document.getElementById('total').innerText = count;
    });

    // Video sync events
    document.getElementById('playBtn').onclick = () => {
      video.play();
      socket.emit('play', { room });
    }

    document.getElementById('pauseBtn').onclick = () => {
      video.pause();
      socket.emit('pause', { room });
    }

    socket.on('play', () => video.play());
    socket.on('pause', () => video.pause());

    // Video upload (host only)
    document.getElementById('videoFile').onchange = async (e) => {
      if(!isHost) return alert("Only host can upload video!");
      const file = e.target.files[0];
      if(!file) return;
      const url = URL.createObjectURL(file);
      video.src = url;
      socket.emit('videoURL', { room, url });
    }

    // Update video for joining users
    socket.on('videoURL', data => {
      video.src = data.url;
    });

    // Sync time every 5 seconds
    setInterval(() => {
      if(isHost && !video.paused){
        socket.emit('timeSync', { room, time: video.currentTime });
      }
    }, 5000);

    socket.on('timeSync', data => {
      if(!isHost) video.currentTime = data.time;
    });
  </script>
</body>
</html>
